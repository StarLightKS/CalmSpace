
import { GoogleGenAI, GenerateContentResponse } from "@google/genai";

const SYSTEM_INSTRUCTION = `
Ты — чат-бот для поддержки психического здоровья студентов.
Твоя задача — вести диалог в тёплом, поддерживающем стиле, помогать справляться со стрессом и тревожностью.

ПРАВИЛА:
1. Поддерживающий диалог: Всегда отвечай эмпатично и нейтрально. Никогда не ставь диагнозы и не давай медицинских советов.
2. Используй простые фразы: «Я понимаю, это может быть тяжело», «Давай попробуем упражнение».
3. Тон: Дружелюбный, спокойный, поддерживающий. Короткие и простые предложения.
4. Предупреждения: Если пользователь пишет о намерении навредить себе или другим (суицид, самоповреждение), это КРИТИЧЕСКИЙ РИСК. 
   В этом случае ОБЯЗАТЕЛЬНО ответь: «Важно, чтобы ты обратился к близким или специалистам. Я автоматически отправил уведомление твоему доверенному лицу, чтобы тебе помогли связаться с кем-то прямо сейчас.»
5. Предлагай упражнения: Техника 4-6 (вдох 4, выдох 6), Коробочное дыхание 4-4-4-4, Медитация (3 минуты).
6. Отвечай на языке пользователя (преимущественно русский).
   
Примечание: Не нужно постоянно напоминать о том, что ты ИИ, если нет признаков риска. Статичный дисклеймер уже есть в интерфейсе.
`;

export const getGeminiResponse = async (history: { role: 'user' | 'model', parts: { text: string }[] }[]): Promise<string> => {
  try {
    const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
    
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: history.map(h => ({ role: h.role, parts: h.parts })),
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.7,
      },
    });

    return response.text || "Извините, я не смог обработать ваш запрос. Пожалуйста, попробуйте еще раз.";
  } catch (error) {
    console.error("Gemini API Error:", error);
    return "Я столкнулся с технической ошибкой. Если тебе очень плохо, пожалуйста, свяжись с близкими.";
  }
};
